"use strict";(function(l,o){function d(r,e){let t=Object.assign({},r);return typeof e!="object"||!e||Object.keys(e).forEach(n=>{e[n]&&typeof e[n]=="object"?((!t[n]||typeof t[n]!="object")&&(t[n]=Array.isArray(e[n])?[]:{}),t[n]=d(t[n],e[n])):t[n]=e[n]}),t}function u(r){let e={vscode:!1,cdnName:"local",defScheme:"",distScheme:"../node_modules/@jhuix/showdowns/dist/",uriPath:"",flavor:"",markdown:{},plantuml:{renderMode:"local",umlWebSite:"www.plantuml.com/plantuml"},mermaid:{},katex:{},vega:{}};return r?d(e,r):e}o=u(o);class p{constructor(e,t){let n=document.createElement("ul");n.classList.add("context-menu-list"),n.style.top="-50%",n.style.display="none",n.style.zIndex="1",this.menus=n,this.selector=e||document,this.cssLinks=[],this.scripts=[],this.initMenuItem(t),document.body.appendChild(this.menus),this.initWindowEvents()}initWindowEvents(){let e=this;this.selector.addEventListener("contextmenu",t=>{t.preventDefault(),e.show(t.clientX,t.clientY)}),document.addEventListener("click",function(t){e.hide()})}initMenuItem(e){if(!(typeof e!="object"||!e)){if(e.hasOwnProperty("style"))for(let t in e.style)this.menus.style[t]=e.style[t];if(e.hasOwnProperty("items")){let t=this,n=e.items;for(let s in n){let i=n[s],c=document.createElement("li");switch(c.classList.add("context-menu-item"),i.type){case"menu":c.appendChild(document.createElement("span")).appendChild(document.createTextNode(i.title)),i.hasOwnProperty("onclick")&&typeof i.onclick=="function"&&c.addEventListener("click",f=>{i.onclick(f,t.selector),t.hide()}),this.menus.appendChild(c);break;case"submenu":c.classList.add("context-menu-submenu"),c.appendChild(document.createElement("span")).appendChild(document.createTextNode(i.title)),this.menus.appendChild(c);break;case"separator":c.classList.add("context-menu-separator"),this.menus.appendChild(c);break}}}}}show(e,t){this.menus.style.display="block",t+this.menus.clientHeight>window.innerHeight-10&&(t-=this.menus.clientHeight+10),e+this.menus.clientWidth>window.innerWidth-10&&(e-=this.menus.clientWidth+10),e+=window.pageXOffset,t+=window.pageYOffset,this.menus.style.left=e+"px",this.menus.style.top=t+"px"}hide(){this.menus.style.display="none",this.menus.style.top="-50%"}}var h={en:{"menu.browsehtml":"Browse HTML Page","menu.exporthtml":"Export \u279D HTML","menu.exportpdf":"Export \u279D PDF","menu.exportpng":"Export \u279D PNG","menu.exportjpg":"Export \u279D JPG"},"zh-cn":{"menu.browsehtml":"\u7528\u6D4F\u89C8\u5668\u6253\u5F00","menu.exporthtml":"\u5BFC\u51FA\u6587\u4EF6 \u279D HTML","menu.exportpdf":"\u5BFC\u51FA\u6587\u4EF6 \u279D PDF","menu.exportpng":"\u5BFC\u51FA\u56FE\u7247 \u279D PNG","menu.exportjpg":"\u5BFC\u51FA\u56FE\u7247 \u279D JPG"}};function a(r){let e=document.children[0].lang;return e||(e="en"),h[e][r]?h[e][r]:""}class w{constructor(e){this.vscodeAPI=null,this.sourceUri="",this.totalLines=0,this.currentLine=-1,this.syncScrollTop=-1,this.resolveCallbacks={},this.config={vscode:e,options:{flavor:o.flavor,markdown:o.markdown,plantuml:o.plantuml,mermaid:o.mermaid,katex:o.katex,vega:o.vega}};let t=document.createElement("div");t.classList.add("workspace-container","main-toc-row"),this.previewElement=t,document.body.appendChild(this.previewElement),this.initWindowEvents(),this.initMenus();let n="";o.uriPath&&(n="file:///"+o.uriPath,this.config.vscode&&(n=new URL(o.defScheme).origin+"/"+o.uriPath)),l.setCDN(o.cdnName,o.defScheme,o.distScheme,n),this.updateOptions(this.config.options),l.init(!0),this.config.vscode?this.postMessage("webviewLoaded",[document.title]):window.dispatchEvent(new CustomEvent("showdownsLoaded",{detail:{phtml:this}}))}updateOptions(e){e.flavor&&l.setShowdownFlavor(e.flavor),e.markdown&&l.setShowdownOptions(e.markdown),e.vega&&l.setVegaOptions(Object.assign({renderer:"svg"},e.vega)),e.mermaid&&l.setMermaidOptions(e.mermaid),e.plantuml&&(e.plantuml.renderMode==="local"?l.setPlantumlOptions({imageFormat:"svg",svgRender:this.renderPlantuml.bind(this)}):l.setPlantumlOptions({imageFormat:"svg",umlWebSite:e.plantuml.umlWebSite})),e.katex&&l.setKatexOptions(e.katex)}getOtherStyles(){let e=[],t=document.getElementById("vega-embed-style");if(t&&t.tagName.toLowerCase()==="style"){let s=t.innerHTML;s=s.replace(/\<br[\/]?\>/g,""),e.push({id:"vega-embed-style",style:s})}let n=document.getElementById("css-abc-audio");if(n&&n.tagName.toLowerCase()==="style"){let s=n.innerHTML;s=s.replace(/\<br[\/]?\>/g,""),e.push({id:"css-abc-audio",style:s})}return e}initMenus(){let e=this,t={style:{zIndex:"1",display:"none"},items:[{type:"menu",title:a("menu.browsehtml"),onclick:function(n,s){e.postMessage("openInBrowser",[e.changeFileProtocol(s.innerHTML),document.title,e.sourceUri,e.cssLinks,e.getOtherStyles(),e.scripts])}},{type:"menu",title:a("menu.exporthtml"),onclick:function(n,s){e.postMessage("exportHTML",[e.changeFileProtocol(s.innerHTML),document.title,e.sourceUri,e.cssLinks,e.getOtherStyles(),e.scripts])}},{type:"menu",title:a("menu.exportpdf"),onclick:function(n,s){e.postMessage("exportPDF",[e.changeFileProtocol(s.innerHTML),document.title,e.sourceUri,e.cssLinks,e.getOtherStyles(),e.scripts])}},{type:"menu",title:a("menu.exportpng"),onclick:function(n,s){e.postMessage("exportPNG",[e.changeFileProtocol(s.innerHTML),document.title,e.sourceUri,e.cssLinks,e.getOtherStyles(),e.scripts])}},{type:"menu",title:a("menu.exportjpg"),onclick:function(n,s){e.postMessage("exportJPEG",[e.changeFileProtocol(s.innerHTML),document.title,e.sourceUri,e.cssLinks,e.getOtherStyles(),e.scripts])}}]};this.contextMenu=new p(this.previewElement,t)}changeFileProtocol(e){return this.config.vscode&&(e=e.replace(new RegExp('(<img.* src=")(.*?vscode-webview.*?)"',"g"),function(t,n,s){let i=new URL(decodeURIComponent(s));return i.protocol="file:",i.host="",s=i.toString(),n+s+'"'}),e=e.replace(new RegExp('"([^"]*?file.*?.vscode-resource.vscode-cdn.net/)(.*?)"',"g"),function(t,n,s){let i=new URL(decodeURIComponent(s));return i.protocol="file:",i.host="",s=i.toString(),'"'+s+'"'})),e.trim()}changeVscodeResourceProtocol(e){if(this.config.vscode){let n=new URL(o.defScheme).origin+"/";e=e.replace(/(\<img.* src=")file:\/\/\//g,"$1"+n),e=e.replace(/(\<img.* src=")\.\//g,"$1"+n+o.uriPath+"/")}return e.trim()}postMessage(e,t=[]){this.config.vscode?(this.vscodeAPI||(this.vscodeAPI=acquireVsCodeApi()),this.vscodeAPI.postMessage({command:e,args:t})):window.parent!==window&&window.parent.postMessage({command:e,args:t},"file://")}renderPlantuml(e,t,n,s){s=s||0;let i=this;return new Promise(c=>{i.resolveCallbacks[e]=c,i.postMessage("renderPlantuml",[{id:e,name:t,code:n,count:s,sourceUri:i.sourceUri}])})}initWindowEvents(){window.addEventListener("keydown",e=>{if(e.shiftKey&&e.ctrlKey&&e.which===83)return this.previewSyncSource()}),window.addEventListener("scroll",e=>{this.scrollEvent(e)}),window.addEventListener("message",e=>{this.messageEvent(e)})}updateMarkdown(e,t){t=t||null,t instanceof Object&&(this.config.options=t,this.updateOptions(t));let n=this;l.makeHtml(e).then(s=>{typeof s=="object"?(n.previewElement.innerHTML=n.changeVscodeResourceProtocol(s.html),n.scripts=[...s.scripts],n.cssLinks=[...s.cssLinks],l.completedHtml(s.scripts,".showdowns"),n.scripts.forEach(i=>{i.code&&typeof i.code=="function"&&(i.code=`(${i.code.toString()})();`),i.inner&&Array.isArray(i.inner)&&i.inner.forEach(c=>{c.code&&typeof c.code=="function"&&(c.code=`(${c.code.toString()})();`)})})):(n.scripts=[],n.cssLinks=[],n.previewElement.innerHTML=n.changeVscodeResourceProtocol(s))}).catch(s=>{n.scripts=[],n.cssLinks=[],n.previewElement.innerHTML="",console.log(s)})}messageEvent(e){let t=e.data;if(t)switch(t.command){case"updateMarkdown":this.sourceUri=t.uri,this.updateMarkdown(t.markdown,t.options),t.title&&(document.title=t.title),this.totalLines=t.totalLines,this.scrollToLine(t.currentLine);break;case"changeVisibleRanges":let n=parseInt(t.line,10);this.scrollToLine(n);break;case"responsePlantuml":if(this.resolveCallbacks.hasOwnProperty(t.id)){let s=this.resolveCallbacks[t.id];delete this.resolveCallbacks[t.id],s&&s(t.response)}break}}checkScrollEnd(){this.syncScrollTop=-1,this.endScrollTimeout=null}scrollEvent(e){this.syncScrollTop>=0?(this.endScrollTimeout&&clearTimeout(this.endScrollTimeout),this.endScrollTimeout=setTimeout(this.checkScrollEnd.bind(this),500)):this.previewSyncSource()}previewSyncSource(){let e=0;if(window.scrollY!==0)if(window.scrollY+window.innerHeight>=this.previewElement.scrollHeight)e=this.totalLines;else{let t=window.scrollY+window.innerHeight/2;e=parseInt(t*this.totalLines/this.previewElement.scrollHeight,10)}this.postMessage("revealLine",[this.sourceUri,e])}scrollToLine(e){if(e!==this.currentLine&&this.totalLines){this.currentLine=e;let t=0;e+1===this.totalLines?t=this.previewElement.scrollHeight:t=parseInt(e*this.previewElement.scrollHeight/this.totalLines,10),window.scrollY!==t&&(this.syncScrollTop=window.scrollY,window.scroll({left:0,top:t,behavior:"smooth"}))}}}function m(){window.mdsp.phtml=new w(o.vscode)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",m):m()})(window.showdowns,window.mdsp&&window.mdsp.options?window.mdsp.options:{});
