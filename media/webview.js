"use strict";(()=>{(function(c,r){function p(a,e){let t=Object.assign({},a);return typeof e!="object"||!e||Object.keys(e).forEach(i=>{e[i]&&typeof e[i]=="object"?((!t[i]||typeof t[i]!="object")&&(t[i]=Array.isArray(e[i])?[]:{}),t[i]=p(t[i],e[i])):t[i]=e[i]}),t}function v(a){let e={vscode:!1,autoToc:!0,cdnName:"local",defScheme:"",distScheme:"../node_modules/@jhuix/showdowns/dist/",uriPath:"",flavor:"",markdown:{},plantuml:{renderMode:"local",umlWebSite:"www.plantuml.com/plantuml"},mermaid:{},katex:{},kroki:{serverUrl:"kroki.io"},toc:{},vega:{},tex:{},shiki:{}};return a?p(e,a):e}r=v(r);class k{constructor(e,t){let i=document.createElement("ul");i.classList.add("context-menu-list"),i.style.top="-50%",i.style.display="none",i.style.zIndex="1",this.menus=i,this.selector=e||document,this.cssLinks=[],this.scripts=[],this.initMenuItem(t),document.body.appendChild(this.menus),this.initWindowEvents()}initWindowEvents(){let e=this;this.selector.addEventListener("contextmenu",t=>{t.preventDefault(),e.show(t.clientX,t.clientY)}),document.addEventListener("click",function(t){e.hide()})}initMenuItem(e){if(!(typeof e!="object"||!e)){if(e.hasOwnProperty("style"))for(let t in e.style)this.menus.style[t]=e.style[t];if(e.hasOwnProperty("items")){let t=this,i=e.items;for(let n in i){let s=i[n],o=document.createElement("li");switch(o.classList.add("context-menu-item"),s.type){case"menu":o.appendChild(document.createElement("span")).appendChild(document.createTextNode(s.title)),s.hasOwnProperty("onclick")&&typeof s.onclick=="function"&&o.addEventListener("click",l=>{s.onclick(l,t.selector),t.hide()}),this.menus.appendChild(o);break;case"submenu":o.classList.add("context-menu-submenu"),o.appendChild(document.createElement("span")).appendChild(document.createTextNode(s.title)),this.menus.appendChild(o);break;case"separator":o.classList.add("context-menu-separator"),this.menus.appendChild(o);break}}}}}show(e,t){this.menus.style.display="block",t+this.menus.clientHeight>window.innerHeight-10&&(t-=this.menus.clientHeight+10),e+this.menus.clientWidth>window.innerWidth-10&&(e-=this.menus.clientWidth+10),e+=window.pageXOffset,t+=window.pageYOffset,this.menus.style.left=e+"px",this.menus.style.top=t+"px"}hide(){this.menus.style.display="none",this.menus.style.top="-50%"}}var f={en:{"menu.browsehtml":"Browse HTML Page","menu.exporthtml":"Export \u279D HTML","menu.exportpdf":"Export \u279D PDF","menu.exportwebp":"Export \u279D WEBP","menu.exportpng":"Export \u279D PNG","menu.exportjpg":"Export \u279D JPG"},"zh-cn":{"menu.browsehtml":"\u7528\u6D4F\u89C8\u5668\u6253\u5F00","menu.exporthtml":"\u5BFC\u51FA\u6587\u4EF6 \u279D HTML","menu.exportpdf":"\u5BFC\u51FA\u6587\u4EF6 \u279D PDF","menu.exportwebp":"\u5BFC\u51FA\u6587\u4EF6 \u279D WEBP","menu.exportpng":"\u5BFC\u51FA\u56FE\u7247 \u279D PNG","menu.exportjpg":"\u5BFC\u51FA\u56FE\u7247 \u279D JPG"}};function u(a){let e=document.children[0].lang;return e||(e="en"),f[e][a]?f[e][a]:""}class y{constructor(e){this.vscodeAPI=null,this.sourceUri="",this.totalLines=0,this.currentLine=-1,this.syncScrollTop=-1,this.resolveCallbacks={},this.config={vscode:e,options:{flavor:r.flavor,markdown:r.markdown,plantuml:r.plantuml,mermaid:r.mermaid,katex:r.katex,kroki:r.kroki,toc:r.toc,vega:r.vega,tex:r.tex,shiki:r.shiki}};let t=document.createElement("div");t.classList.add("workspace-container","main-toc-row"),this.previewElement=t,document.body.appendChild(this.previewElement),this.initWindowEvents(),this.initMenus();let i="";r.uriPath&&(i="file:///"+r.uriPath,this.config.vscode&&(i=new URL(r.defScheme).origin+"/"+r.uriPath)),this.config.options.kroki.svgRender=this.renderKroki.bind(this),this.config.options.tex.svgRender=this.renderTex.bind(this),c.setCDN(r.cdnName,r.defScheme,r.distScheme,i),c.init(!0),this.updateOptions(this.config.options),this.config.vscode?this.postMessage("webviewLoaded",[document.title]):window.dispatchEvent(new CustomEvent("showdownsLoaded",{detail:{phtml:this}}))}updateOptions(e){e.flavor&&c.setShowdownFlavor(e.flavor),e.markdown&&c.setShowdownOptions(e.markdown),e.vega&&c.setVegaOptions(Object.assign({renderer:"svg"},e.vega)),e.mermaid&&c.setMermaidOptions(e.mermaid),e.plantuml&&(e.plantuml.renderMode==="local"?c.setPlantumlOptions({imageFormat:"svg",svgRender:this.renderPlantuml.bind(this)}):c.setPlantumlOptions({imageFormat:"svg",umlWebSite:e.plantuml.umlWebSite})),e.katex&&c.setKatexOptions(e.katex),e.kroki&&c.setKrokiOptions(e.kroki),e.toc&&c.setExtensionOptions("toc",e.toc),e.shiki&&c.setExtensionOptions("shiki",e.shiki),e.tex&&c.setExtensionOptions("tex",e.tex)}getOtherStyles(){let e=[],t=document.getElementById("vega-embed-style");if(t&&t.tagName.toLowerCase()==="style"){let s=t.innerHTML;s=s.replace(/\<br[\/]?\>/g,""),e.push({id:"vega-embed-style",style:s})}let i=document.getElementById("css-abc-audio");if(i&&i.tagName.toLowerCase()==="style"){let s=i.innerHTML;s=s.replace(/\<br[\/]?\>/g,""),e.push({id:"css-abc-audio",style:s})}let n=document.querySelectorAll('[id^="MJX-"]');return n.length>0&&Array.from(n).forEach(s=>{if(s.tagName.toLowerCase()==="style"){let o=s.innerHTML;o=o.replace(/\<br[\/]?\>/g,""),e.push({id:s.id,style:o})}}),e}initMenus(){let e=this,t={style:{zIndex:"1",display:"none"},items:[{type:"menu",title:u("menu.browsehtml"),onclick:function(i,n){e.postMessage("openInBrowser",[e.getPreviewContent(n.innerHTML),document.title,e.sourceUri,e.cssLinks,e.getOtherStyles(),e.scripts])}},{type:"menu",title:u("menu.exporthtml"),onclick:function(i,n){e.postMessage("exportHTML",[e.getPreviewContent(n.innerHTML),document.title,e.sourceUri,e.cssLinks,e.getOtherStyles(),e.scripts])}},{type:"menu",title:u("menu.exportpdf"),onclick:function(i,n){e.postMessage("exportPDF",[e.getPreviewContent(n.innerHTML),document.title,e.sourceUri,e.cssLinks,e.getOtherStyles(),e.scripts])}},{type:"menu",title:u("menu.exportwebp"),onclick:function(i,n){e.postMessage("exportWEBP",[e.getPreviewContent(n.innerHTML),document.title,e.sourceUri,e.cssLinks,e.getOtherStyles(),e.scripts])}},{type:"menu",title:u("menu.exportpng"),onclick:function(i,n){e.postMessage("exportPNG",[e.getPreviewContent(n.innerHTML),document.title,e.sourceUri,e.cssLinks,e.getOtherStyles(),e.scripts])}},{type:"menu",title:u("menu.exportjpg"),onclick:function(i,n){e.postMessage("exportJPEG",[e.getPreviewContent(n.innerHTML),document.title,e.sourceUri,e.cssLinks,e.getOtherStyles(),e.scripts])}}]};this.contextMenu=new k(this.previewElement,t)}changeFileProtocol(e){return this.config.vscode&&(e=e.replace(new RegExp('(<img.* src=")(.*?vscode-webview.*?)"',"g"),function(t,i,n){let s=new URL(decodeURIComponent(n));return s.protocol="file:",s.host="",n=s.toString(),i+n+'"'}),e=e.replace(new RegExp('"([^"]*?file.*?.vscode-resource.vscode-cdn.net/)(.*?)"',"g"),function(t,i,n){let s=new URL(decodeURIComponent(n));return s.protocol="file:",s.host="",n=s.toString(),'"'+n+'"'})),e.trim()}getPreviewContent(e){let t=this.changeFileProtocol(e),i=document.getElementById("MJX-SVG-global-cache");return i?i.outerHTML+t:t}changeVscodeResourceProtocol(e){if(typeof e=="string"){if(this.config.vscode){let i=new URL(r.defScheme).origin+"/";e=e.replace(/(\<img.* src=")file:\/\/\//g,"$1"+i),e=e.replace(/(\<img.* src=")\.\//g,"$1"+i+r.uriPath+"/")}return e.trim()}if(this.config.vscode){let i=new URL(r.defScheme).origin+"/",n=e[0].querySelectorAll("img");n&&n.length>0&&n.forEach(s=>{s.src&&(s.src=s.src.replace(/^file:\/\/\//g,i),s.src=s.src.replace(/^\.\//g,i+r.uriPath+"/"),s.src=s.src.replace(/^vscode-webview:\/\/[^\/\s]+\//g,i+r.uriPath+"/"))})}return e}postMessage(e,t=[]){this.config.vscode?(this.vscodeAPI||(this.vscodeAPI=acquireVsCodeApi()),this.vscodeAPI.postMessage({command:e,args:t})):window.parent!==window&&window.parent.postMessage({command:e,args:t},"file://")}renderPlantuml(e,t,i){let n=this;return new Promise((s,o)=>{n.resolveCallbacks[e]={resolve:s,reject:o},n.postMessage("renderPlantuml",[{id:e,code:t,options:i,sourceUri:n.sourceUri}])})}renderKroki(e,t,i){let n=this;return new Promise((s,o)=>{n.resolveCallbacks[e]={resolve:s,reject:o},n.postMessage("renderKroki",[{id:e,code:t,options:i,sourceUri:n.sourceUri}])})}renderTex(e,t,i){let n=this;return new Promise((s,o)=>{n.resolveCallbacks[e]={resolve:s,reject:o},n.postMessage("renderTex",[{id:e,code:t,options:i,sourceUri:n.sourceUri}])})}initWindowEvents(){window.addEventListener("keydown",e=>{if(e.shiftKey&&e.ctrlKey&&e.which===83)return this.previewSyncSource()}),window.addEventListener("scroll",e=>{this.scrollEvent(e)}),window.addEventListener("message",e=>{this.messageEvent(e)})}updateMarkdown(e,t){t=t||null,t instanceof Object&&(this.config.options=t,this.updateOptions(t)),r.autoToc&&(e=`[TOC]

`+e);let i=s=>{if(s.once||!s.code)return;let o={};return typeof s.code=="function"?o.code=`(${s.code.toString()})();`:o.code=s.code,s.id&&(o.id=s.id),s.host&&(o.host=s.host),s.module&&(o.module=s.module),o},n=this;c.makeHtml({content:e,output:"dom"}).then(s=>{if(typeof s=="object"){let o=n.changeVscodeResourceProtocol(s.html);typeof o=="string"?n.previewElement.innerHTML=o:(n.previewElement.replaceChildren(),o.forEach(l=>{n.previewElement.appendChild(l)})),n.scripts=[],n.cssLinks=[...s.cssLinks],c.completedHtml(s.scripts,".showdowns"),s.scripts.forEach(l=>{let d=i(l);if(l.inner&&Array.isArray(l.inner)){let h=[];l.inner.forEach(m=>{let w=i(m);w&&h.push(w)}),h.length>0&&(d=d??{},d.inner=h)}if(l.outer&&Array.isArray(l.outer)){let h=[];l.outer.forEach(m=>{h.push(m)}),h.length>0&&(d=d??{},d.outer=h)}d&&n.scripts.push(d)})}else n.scripts=[],n.cssLinks=[],n.previewElement.innerHTML=n.changeVscodeResourceProtocol(s)}).catch(s=>{n.scripts=[],n.cssLinks=[],n.previewElement.innerHTML="",console.log(s)})}messageEvent(e){let t=e.data;if(t)switch(t.command){case"updateMarkdown":this.sourceUri=t.uri,this.updateMarkdown(t.markdown,t.options),t.title&&(document.title=t.title),this.totalLines=t.totalLines,this.scrollToLine(t.currentLine);break;case"changeVisibleRanges":let i=parseInt(t.line,10);this.scrollToLine(i);break;case"responsePlantuml":case"responseKroki":case"responseTex":if(this.resolveCallbacks.hasOwnProperty(t.id)){let n=this.resolveCallbacks[t.id];delete this.resolveCallbacks[t.id],n&&(n.resolve&&t.response&&n.resolve(t.response),n.reject&&t.error&&n.reject(t.error))}break}}checkScrollEnd(){this.syncScrollTop=-1,this.endScrollTimeout=null}scrollEvent(e){this.syncScrollTop>=0?(this.endScrollTimeout&&clearTimeout(this.endScrollTimeout),this.endScrollTimeout=setTimeout(this.checkScrollEnd.bind(this),500)):this.previewSyncSource()}previewSyncSource(){let e=0;if(window.scrollY!==0)if(window.scrollY+window.innerHeight>=this.previewElement.scrollHeight)e=this.totalLines;else{let t=window.scrollY+window.innerHeight/2;e=parseInt(t*this.totalLines/this.previewElement.scrollHeight,10)}this.postMessage("revealLine",[this.sourceUri,e])}scrollToLine(e){if(e!==this.currentLine&&this.totalLines){this.currentLine=e;let t=0;e+1===this.totalLines?t=this.previewElement.scrollHeight:t=parseInt(e*this.previewElement.scrollHeight/this.totalLines,10),window.scrollY!==t&&(this.syncScrollTop=window.scrollY,window.scroll({left:0,top:t,behavior:"smooth"}))}}}function g(){window.mdsp.phtml=new y(r.vscode)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",g):g()})(window.showdowns,window.mdsp&&window.mdsp.options?window.mdsp.options:{});})();
//# sourceMappingURL=webview.js.map
