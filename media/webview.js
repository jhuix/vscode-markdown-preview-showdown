"use strict";(()=>{(function(c,r){function f(a,e){let t=Object.assign({},a);return typeof e!="object"||!e||Object.keys(e).forEach(n=>{e[n]&&typeof e[n]=="object"?((!t[n]||typeof t[n]!="object")&&(t[n]=Array.isArray(e[n])?[]:{}),t[n]=f(t[n],e[n])):t[n]=e[n]}),t}function k(a){let e={vscode:!1,autoToc:!0,cdnName:"local",defScheme:"",distScheme:"../node_modules/@jhuix/showdowns/dist/",uriPath:"",flavor:"",markdown:{},plantuml:{renderMode:"local",umlWebSite:"www.plantuml.com/plantuml"},mermaid:{},katex:{},kroki:{serverUrl:"kroki.io"},toc:{},vega:{},tex:{},shiki:{},gnuplot:{}};return a?f(e,a):e}r=k(r);class v{constructor(e,t){let n=document.createElement("ul");n.classList.add("context-menu-list"),n.style.top="-50%",n.style.display="none",n.style.zIndex="1",this.menus=n,this.selector=e||document,this.cssLinks=[],this.scripts=[],this.initMenuItem(t),document.body.appendChild(this.menus),this.initWindowEvents()}initWindowEvents(){let e=this;this.selector.addEventListener("contextmenu",t=>{t.preventDefault(),e.show(t.clientX,t.clientY)}),document.addEventListener("click",function(t){e.hide()})}initMenuItem(e){if(!(typeof e!="object"||!e)){if(e.hasOwnProperty("style"))for(let t in e.style)this.menus.style[t]=e.style[t];if(e.hasOwnProperty("items")){let t=this,n=e.items;for(let s in n){let i=n[s],o=document.createElement("li");switch(o.classList.add("context-menu-item"),i.type){case"menu":o.appendChild(document.createElement("span")).appendChild(document.createTextNode(i.title)),i.hasOwnProperty("onclick")&&typeof i.onclick=="function"&&o.addEventListener("click",l=>{i.onclick(l,t.selector),t.hide()}),this.menus.appendChild(o);break;case"submenu":o.classList.add("context-menu-submenu"),o.appendChild(document.createElement("span")).appendChild(document.createTextNode(i.title)),this.menus.appendChild(o);break;case"separator":o.classList.add("context-menu-separator"),this.menus.appendChild(o);break}}}}}show(e,t){this.menus.style.display="block",t+this.menus.clientHeight>window.innerHeight-10&&(t-=this.menus.clientHeight+10),e+this.menus.clientWidth>window.innerWidth-10&&(e-=this.menus.clientWidth+10),e+=window.pageXOffset,t+=window.pageYOffset,this.menus.style.left=e+"px",this.menus.style.top=t+"px"}hide(){this.menus.style.display="none",this.menus.style.top="-50%"}}var p={en:{"menu.browsehtml":"Browse HTML Page","menu.exporthtml":"Export \u279D HTML","menu.exportpdf":"Export \u279D PDF","menu.exportwebp":"Export \u279D WEBP","menu.exportpng":"Export \u279D PNG","menu.exportjpg":"Export \u279D JPG"},"zh-cn":{"menu.browsehtml":"\u7528\u6D4F\u89C8\u5668\u6253\u5F00","menu.exporthtml":"\u5BFC\u51FA\u6587\u4EF6 \u279D HTML","menu.exportpdf":"\u5BFC\u51FA\u6587\u4EF6 \u279D PDF","menu.exportwebp":"\u5BFC\u51FA\u6587\u4EF6 \u279D WEBP","menu.exportpng":"\u5BFC\u51FA\u56FE\u7247 \u279D PNG","menu.exportjpg":"\u5BFC\u51FA\u56FE\u7247 \u279D JPG"}};function u(a){let e=document.children[0].lang;return e||(e="en"),p[e][a]?p[e][a]:""}class L{constructor(e){this.vscodeAPI=null,this.sourceUri="",this.totalLines=0,this.currentLine=-1,this.syncScrollTop=-1,this.resolveCallbacks={},this.config={vscode:e,options:{flavor:r.flavor,markdown:r.markdown,plantuml:r.plantuml,mermaid:r.mermaid,katex:r.katex,kroki:r.kroki,toc:r.toc,vega:r.vega,tex:r.tex,shiki:r.shiki,gnuplot:r.gnuplot}};let t=document.createElement("div");t.classList.add("workspace-container","main-toc-row"),this.previewElement=t,document.body.appendChild(this.previewElement),this.initWindowEvents(),this.initMenus();let n="";r.uriPath&&(n="file:///"+r.uriPath,this.config.vscode&&(n=new URL(r.defScheme).origin+"/"+r.uriPath)),this.config.options.kroki.svgRender=this.renderKroki.bind(this),this.config.options.tex.svgRender=this.renderTex.bind(this),this.config.options.gnuplot.svgRender=this.renderGnuplot.bind(this),c.setCDN(r.cdnName,r.defScheme,r.distScheme,n),c.onEvent("resetImagePath",this.resetImagePath.bind(this)),c.init(!0),this.updateOptions(this.config.options),this.config.vscode?this.postMessage("webviewLoaded",[document.title]):window.dispatchEvent(new CustomEvent("showdownsLoaded",{detail:{phtml:this}}))}updateOptions(e){e.flavor&&c.setShowdownFlavor(e.flavor),e.markdown&&c.setShowdownOptions(e.markdown),e.vega&&c.setVegaOptions(Object.assign({renderer:"svg"},e.vega)),e.mermaid&&c.setMermaidOptions(e.mermaid),e.plantuml&&(e.plantuml.renderMode==="local"?c.setPlantumlOptions({imageFormat:"svg",svgRender:this.renderPlantuml.bind(this)}):c.setPlantumlOptions({imageFormat:"svg",umlWebSite:e.plantuml.umlWebSite})),e.katex&&c.setKatexOptions(e.katex),e.kroki&&c.setKrokiOptions(e.kroki),e.toc&&c.setExtensionOptions("toc",e.toc),e.shiki&&c.setExtensionOptions("shiki",e.shiki),e.tex&&c.setExtensionOptions("tex",e.tex),e.gnuplot&&c.setExtensionOptions("gnuplot",e.gnuplot)}getOtherLinks(){let e=[];return document.head.querySelectorAll('link[rel="stylesheet"]').forEach(t=>{if(!t.id||t.id[0]!=="_"&&!t.id.startsWith("css-")){let n={link:t.href};t.id&&(n.id=t.id),e.push(n)}}),e}getOtherStyles(){function e(n){let s=n.sheet;if(!s)return"";let i=s.cssRules,o="";for(let l=0;l<i.length;l++)o+=i[l].cssText;return o}let t=[];return document.head.querySelectorAll("style").forEach(n=>{if(!n.id||n.id[0]!=="_"){let s=n.innerHTML;if(!s&&(s=e(n),!s))return;s=s.replace(/\<br[\/]?\>/g,"");let i={style:s};n.id&&(i.id=n.id),t.push(i)}}),t}initMenus(){let e=this,t={style:{zIndex:"1",display:"none"},items:[{type:"menu",title:u("menu.browsehtml"),onclick:function(n,s){e.postMessage("openInBrowser",[e.getPreviewContent(s.innerHTML),document.title,e.sourceUri,[...e.cssLinks,...e.getOtherLinks()],e.getOtherStyles(),e.scripts])}},{type:"menu",title:u("menu.exporthtml"),onclick:function(n,s){e.postMessage("exportHTML",[e.getPreviewContent(s.innerHTML),document.title,e.sourceUri,[...e.cssLinks,...e.getOtherLinks()],e.getOtherStyles(),e.scripts])}},{type:"menu",title:u("menu.exportpdf"),onclick:function(n,s){e.postMessage("exportPDF",[e.getPreviewContent(s.innerHTML),document.title,e.sourceUri,[...e.cssLinks,...e.getOtherLinks()],e.getOtherStyles(),e.scripts])}},{type:"menu",title:u("menu.exportwebp"),onclick:function(n,s){e.postMessage("exportWEBP",[e.getPreviewContent(s.innerHTML),document.title,e.sourceUri,[...e.cssLinks,...e.getOtherLinks()],e.getOtherStyles(),e.scripts])}},{type:"menu",title:u("menu.exportpng"),onclick:function(n,s){e.postMessage("exportPNG",[e.getPreviewContent(s.innerHTML),document.title,e.sourceUri,[...e.cssLinks,...e.getOtherLinks()],e.getOtherStyles(),e.scripts])}},{type:"menu",title:u("menu.exportjpg"),onclick:function(n,s){e.postMessage("exportJPEG",[e.getPreviewContent(s.innerHTML),document.title,e.sourceUri,[...e.cssLinks,...e.getOtherLinks()],e.getOtherStyles(),e.scripts])}}]};this.contextMenu=new v(this.previewElement,t)}changeFileProtocol(e){return this.config.vscode&&(e=e.replace(new RegExp('(<img.* src=")(.*?vscode-webview.*?)"',"g"),function(t,n,s){let i=new URL(decodeURIComponent(s));return i.protocol="file:",i.host="",s=i.toString(),n+s+'"'}),e=e.replace(new RegExp('"([^"]*?file.*?.vscode-resource.vscode-cdn.net/)(.*?)"',"g"),function(t,n,s){let i=new URL(decodeURIComponent(s));return i.protocol="file:",i.host="",s=i.toString(),'"'+s+'"'})),e.trim()}getPreviewContent(e){let t=this.changeFileProtocol(e),n=document.getElementById("MJX-SVG-global-cache");return n?n.outerHTML+t:t}changeVscodeResourceProtocol(e){if(typeof e=="string"){if(this.config.vscode){let n=new URL(r.defScheme).origin+"/";e=e.replace(/(\<img.* src=")file:\/\/\//g,"$1"+n),e=e.replace(/(\<img.* src=")(?![0-9a-zA-Z\-]+\:\/\/)/g,"$1"+n+r.uriPath+"/")}return e.trim()}if(this.config.vscode){let n=new URL(r.defScheme).origin+"/",s=e[0].querySelectorAll("img");s&&s.length>0&&s.forEach(i=>{let o=i.outerHTML.match(/^\<img.* src="((?<![0-9a-zA-Z\-]+\:\/\/)[^"\:\s]+)"/);if(o&&o.length>1){i.src=n+r.uriPath+"/"+o[1];return}o=i.outerHTML.match(/^\<img.* src="file:\/\/\/([^"]*)"/),o&&o.length>1&&(i.src=n+o[1])})}return e}postMessage(e,t=[]){this.config.vscode?(this.vscodeAPI||(this.vscodeAPI=acquireVsCodeApi()),this.vscodeAPI.postMessage({command:e,args:t})):window.parent!==window&&window.parent.postMessage({command:e,args:t},"file://")}resetImagePath(e,t,n){this.resolveCallbacks[e]=n,this.postMessage("resetImagePath",[{id:e,src:t,sourceUri:this.sourceUri}])}renderPlantuml(e,t,n){let s=this;return new Promise((i,o)=>{s.resolveCallbacks[e]={resolve:i,reject:o},s.postMessage("renderPlantuml",[{id:e,code:t,options:n,sourceUri:s.sourceUri}])})}renderKroki(e,t,n){let s=this;return new Promise((i,o)=>{s.resolveCallbacks[e]={resolve:i,reject:o},s.postMessage("renderKroki",[{id:e,code:t,options:n,sourceUri:s.sourceUri}])})}renderTex(e,t,n){let s=this;return new Promise((i,o)=>{s.resolveCallbacks[e]={resolve:i,reject:o},s.postMessage("renderTex",[{id:e,code:t,options:n,sourceUri:s.sourceUri}])})}renderGnuplot(e,t){let n=this;return new Promise((s,i)=>{n.resolveCallbacks[e]={resolve:s,reject:i},n.postMessage("renderGnuplot",[{id:e,code:t,sourceUri:n.sourceUri}])})}initWindowEvents(){window.addEventListener("keydown",e=>{if(e.shiftKey&&e.ctrlKey&&e.which===83)return this.previewSyncSource()}),window.addEventListener("scroll",e=>{this.scrollEvent(e)}),window.addEventListener("message",e=>{this.messageEvent(e)})}updateMarkdown(e,t){t=t||null,t instanceof Object&&(this.config.options=t,this.updateOptions(t)),r.autoToc&&(e=`# [TOC]

`+e);let n=i=>{if(i.once||!i.code)return;let o={};return typeof i.code=="function"?o.code=`(${i.code.toString()})();`:o.code=i.code,i.id&&(o.id=i.id),i.host&&(typeof i.host=="string"?o.host=i.host:o.host=i.host.id),i.module&&(o.module=i.module),o},s=this;c.makeHtml({content:e,output:"dom"}).then(i=>{if(typeof i=="object"){let o=s.changeVscodeResourceProtocol(i.html);typeof o=="string"?s.previewElement.innerHTML=o:(s.previewElement.replaceChildren(),o.forEach(l=>{s.previewElement.appendChild(l)})),s.scripts=[],s.cssLinks=[...i.cssLinks],c.completedHtml(i.scripts,".showdowns"),i.scripts.forEach(l=>{let d=n(l);if(l.inner&&Array.isArray(l.inner)){let h=[];l.inner.forEach(m=>{let w=n(m);w&&h.push(w)}),h.length>0&&(d=d??{},d.inner=h)}if(l.outer&&Array.isArray(l.outer)){let h=[];l.outer.forEach(m=>{h.push(m)}),h.length>0&&(d=d??{},d.outer=h)}d&&s.scripts.push(d)})}else s.scripts=[],s.cssLinks=[],s.previewElement.innerHTML=s.changeVscodeResourceProtocol(i)}).catch(i=>{s.scripts=[],s.cssLinks=[],s.previewElement.innerHTML="",console.log(i)})}messageEvent(e){let t=e.data;if(t)switch(t.command){case"updateMarkdown":this.sourceUri=t.uri,this.updateMarkdown(t.markdown,t.options),t.title&&(document.title=t.title),this.totalLines=t.totalLines,this.scrollToLine(t.currentLine);break;case"changeVisibleRanges":let n=parseInt(t.line,10);this.scrollToLine(n);break;case"onResetImagePath":if(this.resolveCallbacks.hasOwnProperty(t.id)){let s=this.resolveCallbacks[t.id];delete this.resolveCallbacks[t.id],s&&s(t.response)}break;case"onRenderPlantuml":case"onRenderGnuplot":case"onRenderKroki":case"onRenderTex":if(this.resolveCallbacks.hasOwnProperty(t.id)){let s=this.resolveCallbacks[t.id];delete this.resolveCallbacks[t.id],s&&(s.resolve&&t.response&&s.resolve(t.response),s.reject&&t.error&&s.reject(t.error))}break}}checkScrollEnd(){this.syncScrollTop=-1,this.endScrollTimeout=null}scrollEvent(e){this.syncScrollTop>=0?(this.endScrollTimeout&&clearTimeout(this.endScrollTimeout),this.endScrollTimeout=setTimeout(this.checkScrollEnd.bind(this),500)):this.previewSyncSource()}previewSyncSource(){let e=0;if(window.scrollY!==0)if(window.scrollY+window.innerHeight>=this.previewElement.scrollHeight)e=this.totalLines;else{let t=window.scrollY+window.innerHeight/2;e=parseInt(t*this.totalLines/this.previewElement.scrollHeight,10)}this.postMessage("revealLine",[this.sourceUri,e])}scrollToLine(e){if(e!==this.currentLine&&this.totalLines){this.currentLine=e;let t=0;e+1===this.totalLines?t=this.previewElement.scrollHeight:t=parseInt(e*this.previewElement.scrollHeight/this.totalLines,10),window.scrollY!==t&&(this.syncScrollTop=window.scrollY,window.scroll({left:0,top:t,behavior:"smooth"}))}}}function g(){window.mdsp.phtml=new L(r.vscode)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",g):g()})(window.showdowns,window.mdsp&&window.mdsp.options?window.mdsp.options:{});})();
//# sourceMappingURL=webview.js.map
